<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#ef4444" />
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Dyscal" />
  <title>Dyscal ¬∑ PWA plein √©cran</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f4f5f9;
      --text: #0f172a;
      --muted: #475569;
      --surface: #ffffff;
      --shadow: 0 16px 48px rgba(0, 0, 0, 0.08);
      --radius: 22px;
      font-size: 20px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", "SF Pro Display", "Helvetica", "Arial", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .pwa-shell {
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr;
      width: min(100%, 360px);
      margin: 0 auto;
    }

    .top-hero {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(135deg, #fef2f2, #fff5e6);
      padding: env(safe-area-inset-top, 16px) 1.25rem 1.25rem;
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.08);
      border-bottom-left-radius: 28px;
      border-bottom-right-radius: 28px;
    }

    .day-meta {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      color: var(--muted);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .day-meta span:first-child {
      color: #ef4444;
      background: #fee2e2;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
    }

    .now-card {
      margin-top: 0.85rem;
      background: #ef4444;
      color: #ffffff;
      border-radius: 18px;
      padding: 1rem;
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 0.5rem;
    }

    .now-card strong {
      display: block;
      font-size: 1.6rem;
      line-height: 1.1;
    }

    .now-card small {
      display: block;
      opacity: 0.8;
      font-weight: 700;
    }

    .now-emoji {
      font-size: 2.2rem;
    }

    .header-actions {
      margin-top: 0.75rem;
      display: flex;
      justify-content: flex-end;
    }

    .ai-playback {
      border: none;
      background: rgba(255, 255, 255, 0.2);
      color: #111827;
      font-weight: 800;
      padding: 0.65rem 0.85rem;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
      background: #fff7ed;
    }

    .ai-playback[aria-pressed="true"] {
      transform: translateY(1px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      background: #ffe4e6;
    }

    main {
      padding: 1.25rem;
      padding-bottom: calc(2.5rem + env(safe-area-inset-bottom, 0px));
      display: grid;
      gap: 1.5rem;
    }

    .schedule {
      display: grid;
      gap: 0.75rem;
    }

    .slot {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 0.95rem 1.05rem;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 0.75rem;
      align-items: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .slot strong {
      font-size: 1.05rem;
      line-height: 1.25;
    }

    .slot small {
      color: var(--muted);
      font-weight: 600;
    }

    .slot.highlight {
      background: #111827;
      color: #ffffff;
    }

    .slot.highlight small {
      color: rgba(255, 255, 255, 0.8);
    }

    .badge {
      background: #fee2e2;
      color: #991b1b;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      font-weight: 800;
      font-size: 0.9rem;
    }

    .specs-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .specs-card h2 {
      margin: 0 0 0.65rem;
      font-size: 1.15rem;
    }

    .specs-grid {
      display: grid;
      gap: 0.65rem;
    }

    .spec-line {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      font-weight: 700;
      color: #0f172a;
    }

    .spec-line span {
      color: var(--muted);
      font-weight: 600;
    }

    .week-ribbon {
      display: grid;
      gap: 0.75rem;
    }

    .ribbon-day {
      padding: 1rem;
      border-radius: 20px;
      color: #ffffff;
      font-weight: 800;
      font-size: 1.1rem;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.18);
    }

    .ribbon-day span {
      display: block;
      opacity: 0.92;
      font-weight: 700;
      font-size: 0.95rem;
    }

    .palette-red { background: #ef4444; }
    .palette-orange { background: #f97316; }
    .palette-yellow { background: #f59e0b; }
    .palette-green { background: #10b981; }
    .palette-blue { background: #2563eb; }
    .palette-indigo { background: #4338ca; }
    .palette-pink { background: #ec4899; }

    .time-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
      background: var(--surface);
      padding: 0.75rem;
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
    }

    .time-cell {
      padding: 0.75rem;
      text-align: center;
      font-weight: 800;
      border-radius: 14px;
      background: #f8fafc;
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .time-cell.active {
      background: #111827;
      color: #ffffff;
    }

    .bottom-cta {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      width: min(100%, 360px);
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      background: linear-gradient(0deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.7) 100%);
      backdrop-filter: blur(10px);
      display: grid;
      grid-template-columns: 1fr;
    }

    .bottom-cta button {
      width: 100%;
      border: none;
      border-radius: 16px;
      padding: 1rem;
      font-weight: 800;
      font-size: 1rem;
      background: linear-gradient(135deg, #ef4444, #f97316);
      color: #ffffff;
      box-shadow: var(--shadow);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: grid;
      place-items: center;
      padding: 1rem;
    }

    .modal {
      background: var(--surface);
      border-radius: 20px;
      width: min(100%, 360px);
      box-shadow: 0 18px 50px rgba(0, 0, 0, 0.2);
      padding: 1.1rem;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .modal header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }

    .modal h2 {
      margin: 0;
      font-size: 1.2rem;
    }

    .modal .close-btn {
      border: none;
      background: #f8fafc;
      border-radius: 12px;
      padding: 0.5rem 0.65rem;
      cursor: pointer;
      font-weight: 800;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
    }

    .stepper {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .step-pill {
      background: #f8fafc;
      border-radius: 12px;
      padding: 0.6rem 0.75rem;
      text-align: center;
      font-weight: 800;
      color: var(--muted);
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .step-pill.active {
      background: linear-gradient(135deg, #ef4444, #f97316);
      color: #ffffff;
      box-shadow: var(--shadow);
      border-color: transparent;
    }

    .modal form {
      display: grid;
      gap: 1rem;
    }

    .modal label {
      display: grid;
      gap: 0.35rem;
      font-weight: 800;
    }

    .modal input,
    .modal textarea,
    .modal select {
      padding: 0.8rem 0.9rem;
      border-radius: 12px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: #f8fafc;
      font-size: 1rem;
      font-family: inherit;
    }

    .modal textarea {
      min-height: 80px;
      resize: vertical;
    }

    .modal .modal-actions {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .modal .secondary {
      background: #f1f5f9;
      color: var(--text);
    }

    .modal .primary {
      background: linear-gradient(135deg, #ef4444, #f97316);
      color: #ffffff;
    }

    .modal .primary,
    .modal .secondary {
      border: none;
      border-radius: 14px;
      padding: 0.9rem 1rem;
      font-weight: 800;
      flex: 1;
      box-shadow: var(--shadow);
      cursor: pointer;
    }

    .modal .review-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 0.8rem;
      border: 1px solid rgba(0, 0, 0, 0.04);
      display: grid;
      gap: 0.4rem;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="pwa-shell">
    <header class="top-hero">
      <div class="day-meta">
        <span>aujourd'hui</span>
        <span>vingt-cinq juin</span>
        <span aria-hidden="true">‚Ä∫</span>
      </div>
      <div class="now-card" role="alert">
        <div>
          <small>prochain cr√©neau</small>
          <strong id="next-time">sept heures un quart</strong>
        </div>
        <div class="now-emoji" aria-hidden="true" id="next-emoji">üíÉ</div>
      </div>
      <div class="header-actions">
        <button class="ai-playback" type="button" id="ai-playback" aria-pressed="false">
          ‚ñ∂Ô∏è Lecture AI
        </button>
      </div>
    </header>

    <main>
      <section class="specs-card" aria-label="Cahier de sp√©cifications repens√©">
        <h2>Sp√©cifications repens√©es</h2>
        <div class="specs-grid">
          <div class="spec-line">üéß <span>Lecture AI guid√©e pour rejouer le planning.</span></div>
          <div class="spec-line">üì± <span>Largeur contenue √† 360px pour une navigation mobile.</span></div>
          <div class="spec-line">üß© <span>Ajout pas-√†-pas via un modal d√©di√©.</span></div>
          <div class="spec-line">üíæ <span>Activit√©s enregistr√©es et restaur√©es automatiquement.</span></div>
        </div>
      </section>

      <section aria-label="Journ√©e" class="schedule" id="schedule"></section>

      <section aria-label="Rep√®re visuel de la semaine" class="week-ribbon">
        <div class="time-grid" aria-label="Grille textuelle d'heures">
          <div class="time-cell">huit</div>
          <div class="time-cell">z√©ro</div>
          <div class="time-cell">neuf</div>
          <div class="time-cell">cinq</div>
          <div class="time-cell active">dix</div>
          <div class="time-cell active">dix</div>
          <div class="time-cell">onze</div>
          <div class="time-cell">quinze</div>
        </div>
        <div class="ribbon-day palette-red">lundi vingt-cinq juin <span>journ√©e √©coul√©e</span></div>
        <div class="ribbon-day palette-orange">mardi vingt-six juin <span>jour courant</span></div>
        <div class="ribbon-day palette-yellow">mercredi vingt-sept juin <span>t√¢che en priorit√©</span></div>
        <div class="ribbon-day palette-green">jeudi vingt-huit juin <span>planning stable</span></div>
        <div class="ribbon-day palette-blue">vendredi vingt-neuf juin <span>deux cr√©neaux</span></div>
        <div class="ribbon-day palette-indigo">samedi trente juin <span>sport et sortie</span></div>
        <div class="ribbon-day palette-pink">dimanche premier juillet <span>journ√©e famille</span></div>
      </section>
    </main>
  </div>

  <div class="bottom-cta">
    <button type="button" aria-label="Ajouter une activit√©" id="open-modal">Ajouter une activit√©</button>
  </div>

  <div class="modal-backdrop" id="activity-modal" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <header>
        <h2 id="modal-title">Nouvelle activit√©</h2>
        <button class="close-btn" type="button" id="close-modal" aria-label="Fermer">‚úï</button>
      </header>
      <div class="stepper" aria-label="√âtapes du formulaire">
        <div class="step-pill active" data-step-pill="0">1. Emoji</div>
        <div class="step-pill" data-step-pill="1">2. D√©tails</div>
        <div class="step-pill" data-step-pill="2">3. Sp√©cifications</div>
      </div>
      <form id="activity-form">
        <div class="form-step" data-step="0">
          <label for="activity-emoji">
            Choisir un pictogramme
            <input id="activity-emoji" name="emoji" type="text" inputmode="text" maxlength="4" placeholder="üíÉ" required />
          </label>
          <div class="spec-line" style="justify-content: space-between;">
            <span>Suggestions rapides</span>
            <div style="display:flex; gap:0.35rem;">
              <button type="button" class="close-btn" data-emoji="üèä‚Äç‚ôÇÔ∏è" aria-label="Utiliser l'emoji piscine">üèä‚Äç‚ôÇÔ∏è</button>
              <button type="button" class="close-btn" data-emoji="üìñ" aria-label="Utiliser l'emoji lecture">üìñ</button>
              <button type="button" class="close-btn" data-emoji="üíÉ" aria-label="Utiliser l'emoji danse">üíÉ</button>
            </div>
          </div>
        </div>

        <div class="form-step" data-step="1" hidden>
          <label for="activity-time">
            Heure en toutes lettres
            <input id="activity-time" name="time" type="text" placeholder="ex : neuf heures" required />
          </label>
          <label for="activity-title">
            Nom de l'activit√©
            <input id="activity-title" name="title" type="text" placeholder="ex : Piscine" required />
          </label>
        </div>

        <div class="form-step" data-step="2" hidden>
          <label for="activity-notes">
            Sp√©cifications additionnelles
            <textarea id="activity-notes" name="notes" placeholder="lieu, priorit√©, consignes..." ></textarea>
          </label>
          <label style="display:flex; align-items:center; gap:0.5rem;">
            <input type="checkbox" id="activity-priority" name="priority" />
            Marquer comme cr√©neau prioritaire
          </label>
          <div class="review-card" id="review-card">
            <div><strong>Emoji :</strong> <span id="review-emoji">üíÉ</span></div>
            <div><strong>Horaire :</strong> <span id="review-time">--</span></div>
            <div><strong>Activit√© :</strong> <span id="review-title">--</span></div>
            <div><strong>Notes :</strong> <span id="review-notes">--</span></div>
            <div><strong>Priorit√© :</strong> <span id="review-priority">non</span></div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="secondary" id="prev-step">√âtape pr√©c√©dente</button>
          <button type="button" class="primary" id="next-step">√âtape suivante</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const scheduleContainer = document.getElementById('schedule');
    const openModalButton = document.getElementById('open-modal');
    const modal = document.getElementById('activity-modal');
    const closeModalButton = document.getElementById('close-modal');
    const form = document.getElementById('activity-form');
    const stepPills = [...document.querySelectorAll('[data-step-pill]')];
    const steps = [...document.querySelectorAll('.form-step')];
    const prevStepButton = document.getElementById('prev-step');
    const nextStepButton = document.getElementById('next-step');
    const emojiInput = document.getElementById('activity-emoji');
    const timeInput = document.getElementById('activity-time');
    const titleInput = document.getElementById('activity-title');
    const notesInput = document.getElementById('activity-notes');
    const priorityInput = document.getElementById('activity-priority');
    const aiPlaybackButton = document.getElementById('ai-playback');
    const nextTimeLabel = document.getElementById('next-time');
    const nextEmojiLabel = document.getElementById('next-emoji');
    const reviewFields = {
      emoji: document.getElementById('review-emoji'),
      time: document.getElementById('review-time'),
      title: document.getElementById('review-title'),
      notes: document.getElementById('review-notes'),
      priority: document.getElementById('review-priority')
    };

    const storageKey = 'dyscalActivities';
    const defaultActivities = [
      { emoji: 'üíÉ', time: 'sept heures un quart', title: 'Bachata', priority: true, notes: '√©chauffement avant le cours' },
      { emoji: 'üèä‚Äç‚ôÇÔ∏è', time: 'neuf heures', title: 'Piscine', priority: false, notes: 'brasse et dos crawl√©' },
      { emoji: 'üìñ', time: 'dix heures', title: 'R√©visions', priority: false, notes: 'maths + r√©daction' },
      { emoji: 'ü§Ω‚Äç‚ôÇÔ∏è', time: 'onze heures', title: 'Club', priority: false, notes: 'retrouver les copains' },
      { emoji: 'üë®‚Äçüë©‚Äçüëß', time: 'quatorze heures', title: 'Lyon 5', priority: false, notes: 'trajet tram' },
      { emoji: 'üè°', time: 'dix-neuf heures', title: 'Villeneuve', priority: false, notes: 'pr√©parer le sac' },
      { emoji: 'üèãÔ∏è‚Äç‚ôÄÔ∏è', time: 'vingt heures', title: 'Musculation', priority: false, notes: 's√©ance courte' },
      { emoji: '‚ù§Ô∏è', time: 'vingt et une heures', title: 'Amie', priority: false, notes: 'bavardage' }
    ];

    let activities = [];
    let currentStep = 0;
    let isSpeaking = false;

    const suggestionButtons = document.querySelectorAll('[data-emoji]');
    suggestionButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        emojiInput.value = btn.dataset.emoji;
        syncReview();
      });
    });

    function loadActivities() {
      const stored = localStorage.getItem(storageKey);
      if (stored) {
        try {
          activities = JSON.parse(stored);
        } catch (error) {
          activities = [...defaultActivities];
        }
      } else {
        activities = [...defaultActivities];
      }
      saveActivities();
    }

    function saveActivities() {
      localStorage.setItem(storageKey, JSON.stringify(activities));
    }

    function syncReview() {
      reviewFields.emoji.textContent = emojiInput.value || 'üíÉ';
      reviewFields.time.textContent = timeInput.value || '--';
      reviewFields.title.textContent = titleInput.value || '--';
      reviewFields.notes.textContent = notesInput.value?.trim() || 'aucune note';
      reviewFields.priority.textContent = priorityInput.checked ? 'oui' : 'non';
    }

    function renderSchedule() {
      scheduleContainer.innerHTML = '';
      activities.forEach((activity) => {
        const slot = document.createElement('div');
        slot.className = `slot${activity.priority ? ' highlight' : ''}`;

        const emoji = document.createElement('div');
        emoji.setAttribute('aria-hidden', 'true');
        emoji.style.fontSize = '1.6rem';
        emoji.textContent = activity.emoji;

        const info = document.createElement('div');
        const time = document.createElement('strong');
        time.textContent = activity.time;
        const title = document.createElement('small');
        title.textContent = activity.title;
        info.append(time, title);

        const trailing = document.createElement('span');
        trailing.setAttribute('aria-hidden', 'true');
        trailing.textContent = activity.priority ? 'priorit√©' : '‚Ä∫';
        if (activity.priority) {
          trailing.className = 'badge';
        }

        slot.append(emoji, info, trailing);
        scheduleContainer.append(slot);
      });
    }

    function updateNextCard() {
      const nextPriority = activities.find((activity) => activity.priority);
      const nextActivity = nextPriority || activities[0];
      if (!nextActivity) return;
      nextTimeLabel.textContent = nextActivity.time;
      nextEmojiLabel.textContent = nextActivity.emoji;
    }

    function showStep(stepIndex) {
      currentStep = Math.min(Math.max(stepIndex, 0), steps.length - 1);
      steps.forEach((step, index) => {
        step.hidden = index !== currentStep;
      });
      stepPills.forEach((pill, index) => {
        pill.classList.toggle('active', index === currentStep);
      });
      prevStepButton.disabled = currentStep === 0;
      nextStepButton.textContent = currentStep === steps.length - 1 ? 'Enregistrer' : '√âtape suivante';
      syncReview();
    }

    function resetForm() {
      form.reset();
      emojiInput.value = 'üíÉ';
      currentStep = 0;
      showStep(currentStep);
      syncReview();
    }

    function openModal() {
      modal.hidden = false;
      document.body.style.overflow = 'hidden';
      showStep(0);
    }

    function closeModal() {
      modal.hidden = true;
      document.body.style.overflow = '';
      resetForm();
    }

    function addActivity() {
      const newActivity = {
        emoji: emojiInput.value || '‚ùî',
        time: timeInput.value || 'horaire √† d√©finir',
        title: titleInput.value || 'Nouvelle activit√©',
        notes: notesInput.value,
        priority: priorityInput.checked
      };
      activities = [...activities, newActivity];
      saveActivities();
      renderSchedule();
      updateNextCard();
    }

    function handleNext() {
      if (currentStep < steps.length - 1) {
        showStep(currentStep + 1);
        return;
      }
      addActivity();
      closeModal();
    }

    function handlePrev() {
      showStep(currentStep - 1);
    }

    function handlePlayback() {
      if (!('speechSynthesis' in window)) {
        alert('La lecture AI n√©cessite speechSynthesis.');
        return;
      }

      if (isSpeaking) {
        window.speechSynthesis.cancel();
        isSpeaking = false;
        aiPlaybackButton.setAttribute('aria-pressed', 'false');
        return;
      }

      const description = activities
        .map((activity) => `${activity.time}, ${activity.title}`)
        .join('. ');
      const utterance = new SpeechSynthesisUtterance(`Voici ta journ√©e : ${description}`);
      utterance.lang = 'fr-FR';
      utterance.onend = () => {
        isSpeaking = false;
        aiPlaybackButton.setAttribute('aria-pressed', 'false');
      };
      window.speechSynthesis.speak(utterance);
      isSpeaking = true;
      aiPlaybackButton.setAttribute('aria-pressed', 'true');
    }

    openModalButton.addEventListener('click', openModal);
    closeModalButton.addEventListener('click', closeModal);
    prevStepButton.addEventListener('click', handlePrev);
    nextStepButton.addEventListener('click', handleNext);
    aiPlaybackButton.addEventListener('click', handlePlayback);
    form.addEventListener('submit', (event) => event.preventDefault());
    form.addEventListener('input', syncReview);

    loadActivities();
    renderSchedule();
    updateNextCard();
    syncReview();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').catch(() => {
          console.warn('Service worker registration failed');
        });
      });
    }
  </script>
</body>
</html>
